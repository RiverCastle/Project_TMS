<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>하위팀 목록 페이지</title>
    <link rel="stylesheet" type="text/css" href="button.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0; /* 페이지 배경색 설정 */
            margin: 0;
            padding: 0;
        }

        /* 페이지 제목 스타일링 */
        h1 {
            background-color: #007acc; /* 배경색 설정 */
            color: #fff; /* 텍스트 색상 설정 */
            text-align: center; /* 가운데 정렬 */
            padding: 20px 0; /* 위아래 패딩 설정 */
            margin: 0;
        }

        /* 목록 스타일링 */
        ul {
            font-size: medium;
            list-style: none; /* 목록 마커 제거 */
            padding: 0;
            margin: 20px; /* 전체 여백 설정 */
        }

        /* 스타일링을 위한 CSS */
        .search-container {
            justify-content: flex-start; /* 요소를 오른쪽 끝으로 정렬 */
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 10px;
        }

        .search-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 20px;
            margin-right: 30px;

            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>
    <button id="to_main_button" type="button" class="btn btn-info">메인</button>
    하위 조직 목록
    <button id="sub-team-create-button" type="button" class="btn btn-info"> 생성하기</button>
    <button id="logout_button" type="button" class="btn btn-info">로그아웃</button>
</h1>
<ul id="enrolled subteams"></ul>
<!--JWT, Auth, team_id 스크립트-->
<script>
    const teamId = getTeamIdFromURL();
    let Jwt = localStorage.getItem("JWT");
    const auth = "Bearer " + Jwt;

    // URL에서 teamId를 추출하는 함수
    function getTeamIdFromURL() {
        const url = window.location.href;
        const match = url.match(/\/views\/team\/(\d+)\/subteam/); // 정규식을 사용하여 추출
        if (match) {
            return match[1];
        } else {
            throw new Error("Team ID not found in URL");
        }
    }
</script>
<!--하위 팀 목록 조회 api-->
<script>
    const subteam_tags = document.getElementById("enrolled subteams");
    fetch('/api/team/' + teamId + '/subTeam', {
        headers: {
            "Authorization" : auth
        },
        method: "GET"
    })
    .then(response => response.json())
    .then(data => {
        data.forEach(teamOverviewDto => {
            const teamId = teamOverviewDto.id;
            const teamTag = document.createElement('tr');

            const teamNameTag = document.createElement('th');
            teamNameTag.style.width = "20vw";
            teamNameTag.textContent = teamOverviewDto.teamName;
            teamTag.appendChild(teamNameTag);

            const teamDescTag = document.createElement('th');
            teamDescTag.style.width = "40vw";
            teamDescTag.textContent = teamOverviewDto.teamDesc;
            teamTag.appendChild(teamDescTag);

            const teamJoinButton = document.createElement('button');
            teamJoinButton.type = "button";
            teamJoinButton.className = "btn btn-info";
            teamJoinButton.name = "가입하기";
            // 팀 가입 api
            teamJoinButton.addEventListener('click', () => {
                const joinCode = prompt('해당 팀의 참여코드를 입력하세요 :');
                fetch('/api/team/' + teamId + '/member', {
                    headers: {
                        "Authorization": auth,
                        'Content-Type': 'application/json'
                    },
                    method: "POST",
                    body: JSON.stringify({
                        "joinCode": joinCode
                    })
                })
                    .then(response => {
                        if (response.ok) window.location.href = '/views/team/' + teamId;
                    })
                    .catch(error => {
                        alert(error.message);
                    })
            })
            // 추가하기
            teamTag.appendChild(teamJoinButton);
            subteam_tags.appendChild(document.createElement('hr'));
            subteam_tags.appendChild(teamTag);
        })
    })
</script>
<!--하위 팀 생성 버튼 스크립트-->
<script>
    const sub_team_create_button = document.getElementById("sub-team-create-button");
    sub_team_create_button.addEventListener('click', () => {
        const url = "/views/team/" + teamId + "/new-subTeam";
        location.href = url;
    });
</script>
<!--로그아웃 스크립트-->
<script>
    const logout_button = document.getElementById("logout_button");
    logout_button.addEventListener("click", () => {
        localStorage.removeItem("JWT")
        window.location.href = "/views/main";
    })
</script>
<!--메인으로 가기 스크립트-->
<script>
    const main_button = document.getElementById("to_main_button");
    main_button.addEventListener('click', () => {
        window.location.href = "/views/main";
    })
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
</body>
</html>